OBJDIRS	+= parser


PARSERSRC	:= Analysis.cc Annotation.cc embedmysql.cc mysqld-filler.cc cdb_rewrite.cc
PARSERPROGS	:= analyze load-schema print-back cdb_test cdb_enc cdb_dec cdb_exp \
	quick_test inflate sorter pk_appender pg_binfmt

PARSERPROGOBJS	:= $(patsubst %,$(OBJDIR)/parser/%,$(PARSERPROGS))

all:	$(PARSERPROGOBJS) $(OBJDIR)/libedbparser.so

$(OBJDIR)/parser/cdb_exp.o: parser/cdb_exp.cc
	@mkdir -p $(@D)
	$(CXX) -MD $(CXXFLAGS) -c $< -o $@

$(PARSERPROGOBJS): %: %.o $(OBJDIR)/libedbparser.so  $(OBJDIR)/libedbutil.so
	$(CXX) $< -o $@ -ledbparser  $(LDFLAGS) -ledbutil -lcryptdb -ledbcrypto -ledbcrypto2 -lmysqlclient -ltbb -lgmp -lpq

EDBPARSER_OBJS	:= $(patsubst %.cc,$(OBJDIR)/parser/%.o,$(PARSERSRC))
$(OBJDIR)/libedbparser.so: $(EDBPARSER_OBJS) $(OBJDIR)/libedbutil.so $(OBJDIR)/libedbcrypto.so \
				$(OBJDIR)/libedbcrypto2.so	
	$(CXX) -shared -o $@ $(EDBPARSER_OBJS) \
	       -Wl,--whole-archive -L$(MYBUILD)/libmysqld -lmysqld \
	       -Wl,--no-whole-archive $(LDFLAGS) -ledbutil -ledbcrypto -ledbcrypto2

# vim: set noexpandtab:
